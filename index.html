<!-- index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MuscleUP â€” Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="/Themuscleupgym/manifest.json" />
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css" />
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <style>
    body{font-family:Roboto,Arial;background:#f5f5f5;margin:0}
    .card{max-width:520px;margin:6vh auto;padding:20px;background:white;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    h1{margin:6px 0}
    .row{display:flex;gap:8px}
    .full{width:100%}
    .muted{color:#666;font-size:13px}
    .notice{margin-top:10px;color:#b00020}
  </style>
</head>
<body>
  <div class="card">
    <h1>MuscleUP Gym</h1>
    <div class="muted">Login (Owner / Trainer / Customer)</div>

    <div style="margin-top:12px">
      <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="r-owner"><input type="radio" id="r-owner" name="role" value="owner" class="mdl-radio__button"> <span class="mdl-radio__label">Owner</span></label>
      <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="r-trainer"><input type="radio" id="r-trainer" name="role" value="trainer" class="mdl-radio__button"> <span class="mdl-radio__label">Trainer</span></label>
      <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="r-customer"><input type="radio" id="r-customer" name="role" value="customer" class="mdl-radio__button" checked> <span class="mdl-radio__label">Customer</span></label>
    </div>

    <div style="margin-top:14px">
      <div class="mdl-textfield mdl-js-textfield full"><input class="mdl-textfield__input" id="username"><label class="mdl-textfield__label">Username / Code (e.g. ma1003 or mukesh)</label></div>
      <div class="mdl-textfield mdl-js-textfield full"><input class="mdl-textfield__input" id="password" type="password"><label class="mdl-textfield__label">Password</label></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="loginBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">Login</button>
        <button id="resetBtn" class="mdl-button mdl-js-button">Set / Reset Password</button>
      </div>

      <div id="message" class="muted notice"></div>

      <div style="margin-top:14px;font-size:13px" class="muted">
        Owner bootstrap: Use <strong>mukesh / 1234</strong> with role Owner to auto-create owner profile first time.
      </div>

      <div style="margin-top:12px">
        Quick links:
        <a href="/Themuscleupgym/user.html">Customer page</a> |
        <a href="/Themuscleupgym/trainer.html">Trainer page</a> |
        <a href="/Themuscleupgym/owner.html">Owner page</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, unameToEmail, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, ownerCreateUser, getUserProfile, findUserByUsername } from './firebase.js';
    import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const loginBtn = document.getElementById('loginBtn');
    const resetBtn = document.getElementById('resetBtn');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const msg = document.getElementById('message');

    function roleSelected() {
      const r = document.querySelector('input[name="role"]:checked');
      return r ? r.value : 'customer';
    }
    function show(m, color = 'red') { msg.style.color = color; msg.innerText = m; }

    // Owner bootstrap: if owner doesn't exist create auth+profile on mukesh/1234
    async function bootstrapOwnerIfNeeded(username, password, selectedRole) {
      if (username.toLowerCase() === 'mukesh' && password === '1234' && selectedRole === 'owner') {
        show('Bootstrapping owner account...', 'green');
        try {
          // check if user exists by username
          const found = await findUserByUsername('mukesh');
          if (found) {
            show('Owner profile already exists. Try logging in.', 'green');
            return false;
          }
          // create via ownerCreateUser (this will create Auth user and Firestore doc)
          const prof = {
            name: "Mukesh Jakhad",
            username: "mukesh",
            role: "owner",
            branch: "HQ"
          };
          const res = await ownerCreateUser({ username: 'mukesh', role: 'owner', profile: prof, tempPassword: '1234' });
          show('Owner created. Please login now with mukesh / 1234', 'green');
          return true;
        } catch (e) {
          console.error(e);
          show('Bootstrap failed: ' + (e.message||e.code), 'red');
          return false;
        }
      }
      return false;
    }

    loginBtn.addEventListener('click', async () => {
      show('');
      const username = (usernameInput.value || '').trim();
      const password = (passwordInput.value || '').trim();
      const role = roleSelected();
      if (!username || !password) { show('Enter username and password'); return; }
      try {
        // special bootstrap check
        await bootstrapOwnerIfNeeded(username, password, role);
        const email = unameToEmail(username);
        // sign in
        await signInWithEmailAndPassword(auth, email, password);
        // validate role from Firestore
        // locate profile by uid
        const user = auth.currentUser;
        const profSnap = await getDoc(doc(db, 'users', user.uid));
        if (!profSnap.exists()) {
          await signOut(auth);
          show('Profile missing. Contact Owner to create your profile.');
          return;
        }
        const profile = profSnap.data();
        if (profile.role !== role) {
          await signOut(auth);
          show(`Role mismatch. Your account role is "${profile.role}". Choose that role and login.`);
          return;
        }
        // redirect
        show('Login successful. Redirecting...', 'green');
        setTimeout(() => {
          if (role === 'owner') window.location.href = '/Themuscleupgym/owner.html';
          else if (role === 'trainer') window.location.href = '/Themuscleupgym/trainer.html';
          else window.location.href = '/Themuscleupgym/user.html';
        }, 700);
      } catch (err) {
        console.error(err);
        if (err.code === 'auth/user-not-found') show('User not found. Owner must create your account.');
        else if (err.code === 'auth/wrong-password') show('Wrong password. Use Set/Reset Password to create your password.');
        else show(err.message || err.code);
      }
    });

    // Send password reset (users set their password themselves)
    resetBtn.addEventListener('click', async () => {
      show('');
      const username = (usernameInput.value || '').trim();
      if (!username) { show('Enter your username to receive a password reset link.'); return; }
      try {
        const email = unameToEmail(username);
        await sendPasswordResetEmail(auth, email);
        show('Password reset email sent. Check inbox for ' + email, 'green');
      } catch (err) {
        console.error(err);
        show('Failed to send reset email: ' + (err.message||err.code));
      }
    });

    // register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/Themuscleupgym/sw.js').catch(e=>console.warn('sw failed',e));
    }
  </script>
</body>
</html>
