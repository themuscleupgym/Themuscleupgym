<!-- owner.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MuscleUP — Owner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="/Themuscleupgym/manifest.json" />
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css" />
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <style>body{font-family:Roboto;margin:0;padding:12px;background:#f6f7fb}</style>
</head>
<body>
  <h2>Owner — MuscleUP Admin</h2>
  <div style="display:flex;gap:20px;flex-wrap:wrap">
    <div style="flex:1;min-width:320px;background:white;padding:12px;border-radius:6px">
      <h4>Create Trainer</h4>
      <div><input id="trUsername" placeholder="trainer username (e.g. ramesh)"/></div>
      <div>
        Branch:
        <select id="trBranch"></select>
        <button id="addBranchBtn">+ Add Branch</button>
      </div>
      <div><input id="trName" placeholder="Trainer full name"/></div>
      <div><button id="createTrainerBtn">Create Trainer (owner creates account)</button></div>
      <div id="trainerMsg" style="color:green"></div>
    </div>

    <div style="flex:1;min-width:320px;background:white;padding:12px;border-radius:6px">
      <h4>Create Customer</h4>
      <div><input id="custUsername" placeholder="customer username (e.g. MA1003) — leave blank to auto-generate"/></div>
      <div>Assign Branch: <select id="custBranch"></select></div>
      <div><input id="custName" placeholder="Customer full name"/></div>
      <div><button id="createCustBtn">Create Customer</button></div>
      <div id="custMsg" style="color:green"></div>
    </div>

    <div style="flex:1;min-width:320px;background:white;padding:12px;border-radius:6px">
      <h4>Plans & Fees</h4>
      <div><input id="planName" placeholder="Plan name (3 Month)"/></div>
      <div><input id="planMonths" type="number" placeholder="Months"/></div>
      <div><input id="planFee" type="number" placeholder="Fee amount"/></div>
      <div><button id="addPlanBtn">Add Plan</button></div>
      <ul id="plansList"></ul>
    </div>
  </div>

  <hr/>
  <div>
    <h3>Members expiring soon / All users</h3>
    <div id="usersList"></div>
  </div>

<script type="module">
  import { auth, ownerCreateUser, db, findUserByUsername, unameToEmail } from './firebase.js';
  import { collection, addDoc, getDocs, query, where, setDoc, doc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
  import { signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

  // initial branches
  let branches = ['4d campus', 'kedia palace'];
  const trBranchSel = document.getElementById('trBranch');
  const custBranchSel = document.getElementById('custBranch');

  function refreshBranchSelectors() {
    [trBranchSel, custBranchSel].forEach(sel => {
      sel.innerHTML = '';
      branches.forEach(b => {
        const o = document.createElement('option'); o.value = b; o.textContent = b; sel.appendChild(o);
      });
    });
  }
  refreshBranchSelectors();

  document.getElementById('addBranchBtn').addEventListener('click', () => {
    const name = prompt('New branch name:');
    if (name) { branches.push(name); refreshBranchSelectors(); }
  });

  // create trainer
  document.getElementById('createTrainerBtn').addEventListener('click', async () => {
    const username = document.getElementById('trUsername').value.trim();
    const name = document.getElementById('trName').value.trim();
    const branch = trBranchSel.value;
    const out = document.getElementById('trainerMsg');
    out.textContent = '';
    if (!username || !name) { out.textContent = 'Enter username and name'; return; }
    // check username existing
    const existing = await findUserByUsername(username);
    if (existing) { out.textContent = 'Username exists. Choose another.'; return; }
    try {
      const res = await ownerCreateUser({ username, role: 'trainer', profile: { name, branch }, tempPassword: null });
      out.textContent = `Trainer created. Username: ${username}. A temporary password was generated. Ask trainer to "Set/Reset Password" at login to choose password.`;
      loadUsers();
    } catch (e) {
      console.error(e); out.textContent = 'Failed to create trainer: ' + (e.message||e.code);
    }
  });

  // create customer
  document.getElementById('createCustBtn').addEventListener('click', async () => {
    const custInput = document.getElementById('custUsername').value.trim();
    const branch = custBranchSel.value;
    const name = document.getElementById('custName').value.trim();
    const out = document.getElementById('custMsg');
    out.textContent = '';
    // if user provided username, use it; otherwise auto-generate unique code AA1234
    let username = custInput;
    if (!username) {
      // generate: first two letters of name uppercase or 'CU' then 4-digit unique number
      const prefix = (name ? name.substring(0,2).toUpperCase() : 'CU');
      // attempt random unique generator
      let ok=false, tries=0;
      while(!ok && tries<10){
        const num = Math.floor(1000 + Math.random()*9000);
        const candidate = prefix + num;
        const found = await findUserByUsername(candidate);
        if (!found) { username = candidate; ok=true; break; }
        tries++;
      }
      if (!username) { username = prefix + Math.floor(1000+Math.random()*9000); }
    } else {
      const found = await findUserByUsername(username);
      if (found) { out.textContent = 'Provided username already exists.'; return; }
    }
    try {
      const res = await ownerCreateUser({ username, role:'customer', profile:{ name, branch }, tempPassword: null });
      out.textContent = `Customer created with username ${username}. Ask them to 'Set/Reset Password' at login.`;
      loadUsers();
    } catch (e) { console.error(e); out.textContent = 'Create failed: ' + (e.message||e.code); }
  });

  // Plans
  const plans = [];
  document.getElementById('addPlanBtn').addEventListener('click', () => {
    const name = document.getElementById('planName').value;
    const months = parseInt(document.getElementById('planMonths').value||0);
    const fee = parseFloat(document.getElementById('planFee').value||0);
    if (!name || !months || !fee) return alert('Enter plan, months and fee');
    plans.push({ name, months, fee });
    renderPlans(); document.getElementById('planName').value=''; document.getElementById('planMonths').value=''; document.getElementById('planFee').value='';
  });
  function renderPlans(){
    const ul = document.getElementById('plansList'); ul.innerHTML='';
    plans.forEach(p => { const li = document.createElement('li'); li.textContent = `${p.name} — ${p.months} month(s) — ₹${p.fee}`; ul.appendChild(li);});
  }

  // load users summary
  async function loadUsers(){
    const out = document.getElementById('usersList'); out.innerHTML = 'Loading...';
    const usersRef = collection(db, 'users');
    const snap = await getDocs(usersRef);
    out.innerHTML = '';
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const node = document.createElement('div');
      node.textContent = `${d.username} | ${d.role} | ${d.name||''} | Branch: ${d.branch||''}`;
      out.appendChild(node);
    });
  }
  loadUsers();

  // simple sign out button if owner wants to log out
  // (You should protect owner.html so only owner can access — Firestore rules are needed server-side)
</script>
</body>
</html>
