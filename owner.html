<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MuscleUP — Owner</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b2545"/>
  <style>body{font-family:system-ui;margin:0;background:#f4f7fb} header{background:#0b2545;color:#fff;padding:1rem} .wrap{max-width:1100px;margin:1rem auto;padding:1rem;background:white;border-radius:8px} table{width:100%;border-collapse:collapse} td,th{padding:.4rem;border:1px solid #eee}</style>
</head>
<body>
  <header><h1>MuscleUP — Owner Console</h1></header>
  <main class="wrap">
    <div id="ownerArea">
      <h2>Owner: Mukesh Jakhad</h2>

      <h3>Key actions</h3>
      <button id="listExpiring">Memberships expiring in 7 days</button>
      <button id="listExpired">Expired memberships</button>
      <button id="listAll">List all users</button>

      <h3>New trainer</h3>
      <label>Username</label><input id="trainerUser"/>
      <label>Full name</label><input id="trainerName"/>
      <label>Password</label><input id="trainerPass"/>
      <label>Branch</label><input id="trainerBranch"/>
      <button id="createTrainer">Create trainer</button>

      <h3>Search & call</h3>
      <input id="searchTerm" placeholder="Search by name or code"/>
      <button id="searchBtn">Search</button>

      <h3>Results</h3>
      <div id="results"></div>

      <h3>Payments (pending)</h3>
      <div id="paymentsPending"></div>

      <div style="margin-top:1rem"><button id="ownerSignOut">Sign out</button></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref as sref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCI8MBk2m5M9smbjiKwMb3_TDAD-x_eIys",
      authDomain: "muscleup-cfcdd.firebaseapp.com",
      projectId: "muscleup-cfcdd",
      storageBucket: "muscleup-cfcdd.firebasestorage.app",
      messagingSenderId: "164105980592",
      appId: "1:164105980592:web:0675b84e9b9e349d48c975",
      measurementId: "G-HVRMZFH1JC"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Helper to list users by condition
    async function listUsersByQuery(q) {
      const snaps = await getDocs(q);
      return snaps.docs.map(d => ({ id: d.id, data: d.data() }));
    }

    // Expiring in 7 days (owner view)
    document.getElementById('listExpiring').addEventListener('click', async () => {
      const all = await getDocs(collection(db, 'users'));
      const now = new Date();
      const threshold = new Date(now.getTime() + 7*24*60*60*1000);
      const exp = [];
      all.docs.forEach(d=>{
        const u = d.data();
        if (u.membership && u.membership.expiresAt) {
          const ex = new Date(u.membership.expiresAt);
          if (ex <= threshold && ex >= now) exp.push({ id: d.id, data: u });
        }
      });
      renderUsers(exp);
    });

    // Expired
    document.getElementById('listExpired').addEventListener('click', async () => {
      const all = await getDocs(collection(db, 'users'));
      const now = new Date();
      const expired = [];
      all.docs.forEach(d=>{
        const u = d.data();
        if (u.membership && u.membership.expiresAt) {
          const ex = new Date(u.membership.expiresAt);
          if (ex < now) expired.push({ id: d.id, data: u });
        }
      });
      renderUsers(expired);
    });

    document.getElementById('listAll').addEventListener('click', async ()=> {
      const all = await getDocs(collection(db, 'users'));
      renderUsers(all.docs.map(d=>({ id: d.id, data: d.data() })));
    });

    function renderUsers(arr) {
      const html = arr.map(u=>{
        const d = u.data;
        return `<div style="padding:.5rem;border-bottom:1px solid #eee">
          <b>${d.fullName || d.code || d.username}</b> — Role: ${d.role} <br/>
          Code: ${d.code || '-'} | Phone: ${d.phone || '-'} | Branch: ${d.branch || '-'} | Joined: ${d.joinedAt || '-'}
          <br/><button onclick="window.callUser('${d.phone || ''}')">Call</button>
          <button onclick="window.blockUser('${u.id}', ${d.blocked? 'false':'true'})">${d.blocked ? 'Unblock' : 'Block'}</button>
        </div>`;
      }).join('');
      document.getElementById('results').innerHTML = html || 'No results';
    }

    // Expose small actions to window for buttons inside dynamic HTML
    window.callUser = (phone) => {
      if (!phone) return alert('Phone missing');
      location.href = `tel:${phone}`;
    };

    window.blockUser = async (id, toBlock) => {
      await updateDoc(doc(db, 'users', id), { blocked: toBlock });
      alert('Updated block status');
    };

    // Create trainer
    document.getElementById('createTrainer').addEventListener('click', async () => {
      const username = document.getElementById('trainerUser').value.trim();
      const name = document.getElementById('trainerName').value.trim();
      const pass = document.getElementById('trainerPass').value || Math.random().toString(36).slice(-6);
      const branch = document.getElementById('trainerBranch').value.trim();
      if (!username || !name) return alert('username & name required');
      // create doc id predictable
      const trainerDoc = doc(collection(db, 'users')).withConverter();
      // hash pass
      const pwHash = await (async function(p){ const enc=new TextEncoder(); const data=enc.encode(p); const h=await crypto.subtle.digest('SHA-256', data); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); })(pass);
      const dRef = await addDoc(collection(db, 'users'), {
        username,
        passwordHash: pwHash,
        fullName: name,
        role: 'trainer',
        branch,
        createdAt: new Date().toISOString()
      });
      await setDoc(doc(db, 'users_by_username', username), { userRef: dRef.path });
      alert(`Trainer created: ${username} / ${pass}`);
    });

    // Search
    document.getElementById('searchBtn').addEventListener('click', async () => {
      const term = document.getElementById('searchTerm').value.trim().toLowerCase();
      if (!term) return alert('enter search term');
      // search by fullName or code
      const all = await getDocs(collection(db, 'users'));
      const matches = all.docs.filter(d=>{
        const dd = d.data();
        return (dd.fullName && dd.fullName.toLowerCase().includes(term)) || (dd.code && dd.code.toLowerCase().includes(term)) || (dd.username && dd.username.toLowerCase().includes(term));
      }).map(d=>({ id:d.id, data:d.data() }));
      renderUsers(matches);
    });

    // Payments pending
    async function loadPendingPayments() {
      const q = query(collection(db, 'payments'), where('status','==','pending'));
      const snaps = await getDocs(q);
      const html = snaps.docs.map(d=> {
        const p = d.data();
        return `<div style="padding:.4rem;border-bottom:1px solid #eee">
          User: ${p.userId} | Uploaded: ${p.createdAt ? new Date(p.createdAt.seconds*1000).toLocaleString() : 'N/A'}
          <br/> <a href="${p.screenshotURL || '#'}" target="_blank">View proof</a>
          <br/><button onclick="window.approvePayment('${d.id}')">Approve</button>
          <button onclick="window.rejectPayment('${d.id}')">Reject</button>
        </div>`;
      }).join('') || 'No pending';
      document.getElementById('paymentsPending').innerHTML = html;
    }
    window.approvePayment = async (id)=>{ await updateDoc(doc(db, 'payments', id), { status: 'approved', approvedAt: serverTimestamp() }); alert('Approved'); loadPendingPayments(); };
    window.rejectPayment = async (id)=>{ await updateDoc(doc(db, 'payments', id), { status: 'rejected', reviewedAt: serverTimestamp() }); alert('Rejected'); loadPendingPayments(); };

    // initial load
    loadPendingPayments();

    document.getElementById('ownerSignOut').addEventListener('click', ()=>{ sessionStorage.removeItem('muscleup_user'); location.href='index.html'; });

    // register service worker
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(console.error);
  </script>
</main>
</body>
</html>
