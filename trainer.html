<!-- trainer.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MuscleUP Gym - Trainer Dashboard</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getFirestore, collection, query, where, getDocs, addDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
    const firebaseConfig = {/* same config */};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = 'index.html';
      } else {
        const uid = user.uid;
        // Optionally fetch trainer profile info (e.g., branch).
        // For example:
        // const trainerDoc = await getDoc(doc(db, 'users', uid));
        // const trainerData = trainerDoc.data();
        // const branch = trainerData.branch;
        const branch = 'A'; // or fetched from profile
        // Query clients in this branch
        const q = query(collection(db, 'users'), where('role','==','customer'), where('branch','==', branch));
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(docSnap => {
          const client = docSnap.data();
          // Append to client list UI (client.code, client.membershipEnd)
          const li = document.createElement('li');
          li.textContent = `Code: ${client.code} â€“ Expires: ${client.endDate}`;
          document.getElementById('clientList').appendChild(li);
        });
      }
    });
    async function addClient() {
      const name = document.getElementById('newClientName').value;
      const branch = document.getElementById('newClientBranch').value;
      const codePrefix = name.substr(0,2).toUpperCase();
      // Generate a unique 4-digit code (check DB for repeats).
      let randNum;
      do {
        randNum = Math.floor(Math.random() * 9000) + 1000;
      } while (await checkCodeExists(codePrefix + randNum));
      const newCode = codePrefix + randNum;
      await addDoc(collection(db, 'users'), {
        name: name,
        code: newCode,
        branch: branch,
        role: 'customer',
        startDate: new Date().toLocaleDateString(),
        endDate: 'N/A',
        // leave phone/address out of trainer view; store if needed
      });
      alert('New client added with code: ' + newCode);
      location.reload();
    }
    async function checkCodeExists(code) {
      const q = query(collection(db, 'users'), where('code','==', code));
      const snap = await getDocs(q);
      return !snap.empty;
    }
  </script>
</head>
<body>
  <h2>Trainer Dashboard</h2>
  <p>Your Branch: <span id="trainerBranch">A</span></p>
  <h3>My Clients</h3>
  <ul id="clientList"></ul>
  <h3>Add New Client</h3>
  <input id="newClientName" type="text" placeholder="Client Name">
  <input id="newClientBranch" type="text" placeholder="Branch" value="A">
  <button onclick="addClient()">Add Client</button>
  <!-- The list items above only show code and expiry; clicking a code could open detailed view -->
</body>
</html>
