<!-- trainer.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MuscleUP — Trainer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="/Themuscleupgym/manifest.json" />
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css" />
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
</head>
<body style="font-family:Roboto;padding:12px;background:#f4f6fb">
  <h2>Trainer Dashboard</h2>
  <div>
    <div>
      <label>Login here first on this page (username & password)</label><br/>
      <input id="loginUser" placeholder="username"><input id="loginPass" placeholder="password" type="password">
      <button id="loginBtn">Login</button>
      <span id="tmsg" style="color: red"></span>
    </div>

    <div id="trainerPanel" style="display:none;margin-top:12px">
      <h4>Your branch: <span id="trainerBranch"></span></h4>
      <h4>Your customers (codes only)</h4>
      <ul id="customerList"></ul>

      <h4>Add Customer (Trainer)</h4>
      <input id="tCustName" placeholder="Name">
      <button id="tAddCustBtn">Add Customer</button>
      <div id="tCreateMsg" style="color:green"></div>
    </div>
  </div>

<script type="module">
  import { auth, unameToEmail, signInWithEmailAndPassword, findUserByUsername, ownerCreateUser, getUserProfile, db } from './firebase.js';
  import { collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
  import { signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

  const loginBtn = document.getElementById('loginBtn');
  const tmsg = document.getElementById('tmsg');

  loginBtn.addEventListener('click', async () => {
    tmsg.textContent = '';
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();
    if (!u||!p){ tmsg.textContent='Enter credentials'; return; }
    try {
      await signInWithEmailAndPassword(auth, unameToEmail(u), p);
      const uid = auth.currentUser.uid;
      const profile = await getUserProfile(uid);
      if (!profile || profile.role !== 'trainer') { tmsg.textContent = 'Not a trainer account or profile missing'; await signOut(auth); return; }
      document.getElementById('trainerBranch').textContent = profile.branch || 'N/A';
      document.getElementById('trainerPanel').style.display = 'block';
      loadCustomers(profile.branch);
    } catch (e) {
      console.error(e); tmsg.textContent = e.message || e.code;
    }
  });

  async function loadCustomers(branch) {
    const ul = document.getElementById('customerList');
    ul.innerHTML = 'Loading...';
    const usersRef = collection(db, 'users');
    const q = query(usersRef, where('role','==','customer'), where('branch','==',branch));
    const snap = await getDocs(q);
    ul.innerHTML = '';
    snap.forEach(s => {
      const d = s.data();
      const li = document.createElement('li');
      li.textContent = `${d.username} — expires: ${d.endDate||'N/A'}`;
      ul.appendChild(li);
    });
  }

  // trainer adds customer (owner rights not required)
  document.getElementById('tAddCustBtn').addEventListener('click', async () => {
    const name = document.getElementById('tCustName').value.trim();
    if (!name) return alert('Enter name');
    // create username prefix from name
    const prefix = name.substring(0,2).toUpperCase() || 'CU';
    // ensure uniqueness (simple)
    let uname = null;
    for (let i=0;i<10;i++){
      const candidate = prefix + (1000 + Math.floor(Math.random()*9000));
      const exists = await findUserByUsername(candidate);
      if (!exists){ uname = candidate; break; }
    }
    if (!uname) return alert('Failed to generate code. Try again.');
    try {
      // create user via ownerCreateUser helper ensures auth + firestore doc
      await ownerCreateUser({ username: uname, role: 'customer', profile: { name, branch: document.getElementById('trainerBranch').textContent }, tempPassword: null });
      document.getElementById('tCreateMsg').textContent = `Customer created: ${uname}. Ask them to reset password at login.`;
      loadCustomers(document.getElementById('trainerBranch').textContent);
    } catch (e) {
      console.error(e); alert('Create failed: ' + (e.message||e.code));
    }
  });
</script>
</body>
</html>
