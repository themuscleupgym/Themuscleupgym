<!-- user.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MuscleUP — Member</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="/Themuscleupgym/manifest.json" />
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css" />
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <style>body{font-family:Roboto;padding:12px;background:#eef2fb}</style>
</head>
<body>
  <h2>Member Dashboard</h2>
  <div id="authArea">
    <label>Login here (username / password)</label><br/>
    <input id="uUser"><input id="uPass" type="password"><button id="uLogin">Login</button>
    <button id="uReset">Reset Password</button>
    <div id="uMsg" style="color:red"></div>
  </div>

  <div id="profileArea" style="display:none">
    <h3 id="pName"></h3>
    <div>Code: <span id="pCode"></span></div>
    <div>Joined: <span id="pStart"></span> — Expires: <span id="pEnd"></span></div>
    <div>Phone: <span id="pPhone"></span></div>

    <h4>Attendance</h4>
    <button id="markAttend">Mark Present Today</button>
    <ul id="attList"></ul>

    <h4>Log Workout</h4>
    <input id="wText" placeholder="Workout details"><button id="logW">Add</button>
    <ul id="wList"></ul>

    <h4>Payments</h4>
    <div>Owner UPI: <span id="ownerUpi">Not set</span></div>
    <input type="file" id="payProof"><button id="uploadPay">Upload Payment Screenshot</button>
    <div id="payMsg" style="color:green"></div>

    <h4>Profile Photo</h4>
    <input type="file" id="profilePhoto"><button id="uploadPhoto">Upload Photo</button>
    <img id="photoPreview" style="max-width:160px;display:block;margin-top:8px"/>

  </div>

<script type="module">
  import { auth, unameToEmail, signInWithEmailAndPassword, sendPasswordResetEmail, getUserProfile, uploadFile, db } from './firebase.js';
  import { doc, getDoc, collection, addDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
  import { createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

  const uLogin = document.getElementById('uLogin');
  const uReset = document.getElementById('uReset');
  const uUser = document.getElementById('uUser');
  const uPass = document.getElementById('uPass');
  const uMsg = document.getElementById('uMsg');

  uLogin.addEventListener('click', async () => {
    uMsg.textContent='';
    const username = (uUser.value||'').trim(); const pass = (uPass.value||'').trim();
    if (!username || !pass){ uMsg.textContent='Enter credentials'; return; }
    try {
      await signInWithEmailAndPassword(auth, unameToEmail(username), pass);
      const uid = auth.currentUser.uid;
      const profileSnap = await getDoc(doc(db,'users',uid));
      if (!profileSnap.exists()){ uMsg.textContent='Profile missing. Contact owner.'; return; }
      const profile = profileSnap.data();
      if (profile.role !== 'customer'){ uMsg.textContent='Not a customer account'; return; }
      // show profile area
      document.getElementById('authArea').style.display='none';
      document.getElementById('profileArea').style.display='block';
      document.getElementById('pName').innerText = profile.name || '';
      document.getElementById('pCode').innerText = profile.username || '';
      document.getElementById('pStart').innerText = profile.startDate || '';
      document.getElementById('pEnd').innerText = profile.endDate || '';
      document.getElementById('pPhone').innerText = profile.phone || '';
    } catch (e) { console.error(e); uMsg.textContent = e.message || e.code; }
  });

  uReset.addEventListener('click', async () => {
    const username = (uUser.value||'').trim();
    if (!username){ uMsg.textContent='Enter username to reset'; return; }
    try {
      await sendPasswordResetEmail(auth, unameToEmail(username));
      uMsg.style.color='green'; uMsg.textContent='Password reset email sent';
    } catch (e){ console.error(e); uMsg.textContent = e.message || e.code; }
  });

  // mark attendance: store in users/{uid}/attendance
  document.getElementById('markAttend').addEventListener('click', async () => {
    const uid = auth.currentUser.uid;
    await addDoc(collection(db, 'users', uid, 'attendance'), { date: new Date().toISOString(), createdAt: new Date().toISOString() });
    alert('Attendance recorded');
  });

  document.getElementById('logW').addEventListener('click', async () => {
    const uid = auth.currentUser.uid;
    const text = document.getElementById('wText').value;
    if (!text) return alert('Enter workout');
    await addDoc(collection(db, 'users', uid, 'workouts'), { text, date: new Date().toISOString() });
    alert('Workout logged');
  });

  document.getElementById('uploadPhoto').addEventListener('click', async () => {
    const f = document.getElementById('profilePhoto').files[0];
    if (!f) return alert('Choose photo');
    const uid = auth.currentUser.uid;
    const url = await uploadFile(`users/${uid}/profile.jpg`, f);
    await setDoc(doc(db,'users',uid), { profilePicUrl: url }, { merge:true });
    document.getElementById('photoPreview').src = url;
    alert('Profile photo uploaded');
  });

  document.getElementById('uploadPay').addEventListener('click', async () => {
    const f = document.getElementById('payProof').files[0];
    if (!f) return alert('Choose screenshot');
    const uid = auth.currentUser.uid;
    // create payment record
    const payRef = await addDoc(collection(db, 'payments'), { userUid: uid, status: 'pending', createdAt: new Date().toISOString() });
    const url = await uploadFile(`payments/${payRef.id}/proof.jpg`, f);
    await setDoc(doc(db,'payments',payRef.id), { proofUrl: url, userUid: uid, status: 'pending', createdAt: new Date().toISOString() }, { merge:true });
    document.getElementById('payMsg').textContent = 'Uploaded. Owner will verify.';
  });

</script>
</body>
</html>
